parameters:
  imagetag: 'vsts-$(Build.BuildId)'
  language: ''

steps:

- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'
    architecture: 'x64'

- script: |
    scripts/setup-python36.sh
  displayName: 'install python libs'

- script: |
    scripts/setup-iotedge.sh
  displayName: 'install iotedge packages'

- script: |
    docker login -u ${IOTHUB_E2E_REPO_USER} -p ${IOTHUB_E2E_REPO_PASSWORD} ${IOTHUB_E2E_REPO_ADDRESS}
    docker pull mcr.microsoft.com/azureiotedge-agent:1.0.5
    docker pull mcr.microsoft.com/azureiotedge-hub:1.0.5
    docker pull ${IOTHUB_E2E_REPO_ADDRESS}/edge-e2e-node6
    docker pull ${IOTHUB_E2E_REPO_ADDRESS}/${{ parameters.language }}-e2e:${{ parameters.imagetag }}
  displayName: 'pre-cache docker images'
  env:
    IOTHUB_E2E_CONNECTION_STRING: $(IOTHUB-E2E-CONNECTION-STRING)
    IOTHUB_E2E_REPO_ADDRESS: $(IOTHUB-E2E-REPO-ADDRESS)
    IOTHUB_E2E_REPO_USER: $(IOTHUB-E2E-REPO-USER)
    IOTHUB_E2E_REPO_PASSWORD: $(IOTHUB-E2E-REPO-PASSWORD)

- script: |
    scripts/create-new-edgehub-device.sh 
  displayName: 'Create new edgehub device'
  env:
    IOTHUB_E2E_CONNECTION_STRING: $(IOTHUB-E2E-CONNECTION-STRING)
    IOTHUB_E2E_REPO_ADDRESS: $(IOTHUB-E2E-REPO-ADDRESS)
    IOTHUB_E2E_REPO_USER: $(IOTHUB-E2E-REPO-USER)
    IOTHUB_E2E_REPO_PASSWORD: $(IOTHUB-E2E-REPO-PASSWORD)
    IOTEDGE_DEBUG_LOG: $(IOTEDGE_DEBUG_LOG)

- script: |
    python3 test-runner/deploy_test_containers.py --friend --${{ parameters.language }} ${IOTHUB_E2E_REPO_ADDRESS}/${{ parameters.language }}-e2e:${{ parameters.imagetag }}
  displayName: 'Deploy new container'
  env:
    IOTHUB_E2E_CONNECTION_STRING: $(IOTHUB-E2E-CONNECTION-STRING)
    IOTHUB_E2E_REPO_ADDRESS: $(IOTHUB-E2E-REPO-ADDRESS)
    IOTHUB_E2E_REPO_USER: $(IOTHUB-E2E-REPO-USER)
    IOTHUB_E2E_REPO_PASSWORD: $(IOTHUB-E2E-REPO-PASSWORD)
    IOTEDGE_DEBUG_LOG: $(IOTEDGE_DEBUG_LOG)

- script: |
    scripts/verify-deployment.sh ${{ parameters.language }}Mod ${IOTHUB_E2E_REPO_ADDRESS}/${{ parameters.language }}-e2e:${{ parameters.imagetag }}
  displayName: 'Verify deployment'
  env:
    IOTHUB_E2E_CONNECTION_STRING: $(IOTHUB-E2E-CONNECTION-STRING)
    IOTHUB_E2E_REPO_ADDRESS: $(IOTHUB-E2E-REPO-ADDRESS)
    IOTHUB_E2E_REPO_USER: $(IOTHUB-E2E-REPO-USER)
    IOTHUB_E2E_REPO_PASSWORD: $(IOTHUB-E2E-REPO-PASSWORD)
    IOTEDGE_DEBUG_LOG: $(IOTEDGE_DEBUG_LOG)

