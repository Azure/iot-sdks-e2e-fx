parameters:
  language: ''
  repo_address: $(IOTHUB-E2E-REPO-ADDRESS)
  repo_user: $(IOTHUB-E2E-REPO-USER)
  repo_password: $(IOTHUB-E2E-REPO-PASSWORD)
  image_edgeHub: mcr.microsoft.com/azureiotedge-hub:1.0
  image_edgeAgent: mcr.microsoft.com/azureiotedge-agent:1.0
  image_friendMod: $(IOTHUB-E2E-REPO-ADDRESS)/default-friend-module:latest
  test_image: ''
  
steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '3.x'
    architecture: 'x64'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/setup/setup-python36.ps1
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'Install python libs'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- script: $(Horton.FrameworkRoot)/scripts/setup/setup-iotedge.sh
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'Install iotedge packages'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/precache-images.ps1 ${{ parameters.language }} ${{ parameters.test_image }} ${{ parameters.image_edgeAgent }} ${{ parameters.image_edgeHub }} ${{ parameters.image_friendmod }}
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'Pre-cache docker images'
  env:
    IOTHUB_E2E_REPO_ADDRESS: $(IOTHUB-E2E-REPO-ADDRESS)
    IOTHUB_E2E_REPO_USER: $(IOTHUB-E2E-REPO-USER)
    IOTHUB_E2E_REPO_PASSWORD: $(IOTHUB-E2E-REPO-PASSWORD)
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/create-new-edgehub-device.ps1
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'Create new edgehub identity'
  env:
    IOTHUB_E2E_CONNECTION_STRING: $(IOTHUB-E2E-CONNECTION-STRING)
    IOTHUB_E2E_REPO_ADDRESS: $(IOTHUB-E2E-REPO-ADDRESS)
    IOTHUB_E2E_REPO_USER: $(IOTHUB-E2E-REPO-USER)
    IOTHUB_E2E_REPO_PASSWORD: $(IOTHUB-E2E-REPO-PASSWORD)
    IOTEDGE_DEBUG_LOG: $(IOTEDGE_DEBUG_LOG)
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/deploy-test-containers.ps1 ${{ parameters.language }} ${{ parameters.repo_address }}/${{ parameters.language }}-e2e-v3:${{ parameters.test_image }}
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'Deploy manifest (${{ parameters.test_image }})'
  env:
    IOTHUB_E2E_CONNECTION_STRING: $(IOTHUB-E2E-CONNECTION-STRING)
    IOTHUB_E2E_REPO_ADDRESS: $(IOTHUB-E2E-REPO-ADDRESS)
    IOTHUB_E2E_REPO_USER: $(IOTHUB-E2E-REPO-USER)
    IOTHUB_E2E_REPO_PASSWORD: $(IOTHUB-E2E-REPO-PASSWORD)
    IOTEDGE_DEBUG_LOG: $(IOTEDGE_DEBUG_LOG)
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/verify-deployment.ps1 edgeHub ${{ parameters.image_edgeHub }}
  displayName: 'Verify edgeHub deployment'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/verify-deployment.ps1 edgeAgent ${{ parameters.image_edgeAgent }}
  displayName: 'Verify edgeAgent deployment'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/verify-deployment.ps1 friendMod ${{ parameters.image_friendMod }}
  displayName: 'Verify friendMod deployment'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/verify-deployment.ps1 ${{ parameters.language }}Mod ${{ parameters.repo_address }}/${{ parameters.language }}-e2e-v3:${{ parameters.test_image }}
  displayName: 'Verify deploymet ${{ parameters.language }}Mod ${{ parameters.repo_address }}/${{ parameters.language }}-e2e-v3:${{ parameters.test_image }}'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/verify-container-running.ps1 ${{ parameters.language }}Mod
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'Verify that ${{ parameters.language }}Mod is responding'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: $(Horton.FrameworkRoot)/scripts/verify-container-running.ps1 friendMod
  workingDirectory: $(Horton.FrameworkRoot)
  displayName: 'Verify that friendMod is responding'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))

- powershell: |
    Start-Sleep -s 30  
  displayName: 'give edgeHub 30 seconds to start up'
  condition: and(succeeded(), ne(variables['skipTest'],'yes'))
  
